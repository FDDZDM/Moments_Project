<template>
  <AdminLayout current-path="user" page-title="ç”¨æˆ·ç®¡ç†">
    <view class="user-manage">
      <!-- ç­›é€‰æ  -->
      <view class="filter-card">
        <view class="filter-item search-box">
          <text class="iconfont search-icon">ğŸ”</text>
          <input 
            v-model="filter.keyword" 
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±æœç´¢" 
            class="search-input"
          />
        </view>
        
        <view class="filter-item date-range">
          <picker mode="date" v-model="filter.startDate">
            <view class="date-picker">{{ filter.startDate || 'å¼€å§‹æ—¥æœŸ' }}</view>
          </picker>
          <text class="date-separator">-</text>
          <picker mode="date" v-model="filter.endDate">
            <view class="date-picker">{{ filter.endDate || 'ç»“æŸæ—¥æœŸ' }}</view>
          </picker>
        </view>
        
        <view class="filter-item">
          <picker v-model="filter.status" :range="statusOptions" range-key="label">
            <view class="select-box">
              {{ statusOptions.find(item => item.value === filter.status).label }}
              <text class="arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <button @click="getUserList" class="btn btn-primary">æŸ¥è¯¢</button>
      </view>
      
      <!-- ç”¨æˆ·åˆ—è¡¨ -->
      <view class="table-card">
        <view class="table-scroll">
          <view class="table-header">
            <view class="col col-user">ç”¨æˆ·ä¿¡æ¯</view>
            <view class="col col-date">æ³¨å†Œæ—¶é—´</view>
            <view class="col col-status">çŠ¶æ€</view>
            <view class="col col-action">æ“ä½œ</view>
          </view>
          
          <view class="table-body">
            <view class="table-row" v-for="user in userList" :key="user._id">
              <view class="col col-user">
                <view class="user-cell">
                  <view class="user-avatar">{{ user.username.charAt(0).toUpperCase() }}</view>
                  <view class="user-info">
                    <text class="username">{{ user.username }}</text>
                    <text class="email">{{ user.email || 'æœªç»‘å®šé‚®ç®±' }}</text>
                  </view>
                </view>
              </view>
              <view class="col col-date">{{ formatDate(user.create_time) }}</view>
              <view class="col col-status">
                <text class="status-badge" :class="user.status === 0 ? 'active' : 'disabled'">
                  {{ user.status === 0 ? 'æ­£å¸¸' : 'å·²ç¦ç”¨' }}
                </text>
              </view>
              <view class="col col-action">
                <view class="action-btn primary" @click.stop="viewUserDetail(user._id)">è¯¦æƒ…</view>
                <view class="action-btn warning" @click.stop="toggleUserStatus(user._id, user.status)">
                  {{ user.status === 0 ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                </view>
                <view class="action-btn danger" @click.stop="showDeleteConfirm(user._id)">åˆ é™¤</view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        <view class="pagination-container" v-if="total > 0">
          <text class="total-text">å…± {{ total }} æ¡æ•°æ®</text>
          <view class="page-ctrl">
            <button class="page-btn" @click="changePage(page - 1)" :disabled="page <= 1">ä¸Šä¸€é¡µ</button>
            <text class="page-num">{{ page }} / {{ totalPages }}</text>
            <button class="page-btn" @click="changePage(page + 1)" :disabled="page >= totalPages">ä¸‹ä¸€é¡µ</button>
          </view>
        </view>
      </view>
      
    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— (ä¿æŒåŸæœ‰) -->
    <uni-popup ref="deletePopupRef" type="dialog">
      <uni-popup-dialog 
        title="åˆ é™¤ç¡®è®¤" 
        content="ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åŒæ­¥åˆ é™¤ç”¨æˆ·å‘å¸ƒçš„å†…å®¹å’Œè¯„è®ºï¼"
        @confirm="confirmDelete"
        @close="cancelDelete"
      ></uni-popup-dialog>
    </uni-popup>
    </view>
  </AdminLayout>
</template>

<script setup>
import { ref, reactive } from 'vue'
import { onLoad, onShow } from '@dcloudio/uni-app'
import AdminLayout from '@/admin/components/AdminLayout.uvue'

// ... (keep logic)
// æƒé™æ£€æŸ¥
onShow(() => {
  const token = uni.getStorageSync('adminToken')
  if (!token) {
    uni.reLaunch({ url: '/pages/login/login' })
  }
})

// çŠ¶æ€é€‰é¡¹
const statusOptions = ref([
  { value: 'all', label: 'å…¨éƒ¨çŠ¶æ€' },
  { value: 'active', label: 'æ­£å¸¸ç”¨æˆ·' },
  { value: 'disabled', label: 'ç¦ç”¨ç”¨æˆ·' }
])

// ç­›é€‰æ¡ä»¶
const filter = reactive({
  keyword: '',
  startDate: '',
  endDate: '',
  status: 'all'
})

// åˆ—è¡¨æ•°æ®
const userList = ref([])
const total = ref(0)
const page = ref(1)
const pageSize = ref(10)
const totalPages = ref(0)
const deleteUserId = ref('')
const deletePopupRef = ref<any>(null)

// é¡µé¢åŠ è½½è·å–ç”¨æˆ·åˆ—è¡¨
onLoad(() => {
  if (uni.getStorageSync('adminToken')) {
    getUserList()
  }
})

// è·å–ç”¨æˆ·åˆ—è¡¨
const getUserList = async () => {
  try {
    const res = await uniCloud.callFunction({
      name: 'admin-api',
      data: {
        action: 'getUserList',
        keyword: filter.keyword,
        startDate: filter.startDate,
        endDate: filter.endDate,
        status: filter.status,
        page: page.value,
        pageSize: pageSize.value,
        token: uni.getStorageSync('adminToken')
      }
    })
    if (res.result.code === 200) {
      userList.value = res.result.data.list
      total.value = res.result.data.total
      totalPages.value = res.result.data.totalPages
    } else {
      uni.showToast({ title: res.result.message, icon: 'none' })
    }
  } catch (e) {
    uni.showToast({ title: 'è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥', icon: 'none' })
  }
}

// åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
const toggleUserStatus = async (userId, currentStatus) => {
  try {
    const newStatus = currentStatus === 0 ? 1 : 0
    const res = await uniCloud.callFunction({
      name: 'admin-api',
      data: {
        action: 'toggleUserStatus',
        user_id: userId,
        status: newStatus,
        token: uni.getStorageSync('adminToken')
      }
    })
    if (res.result.code === 200) {
      uni.showToast({ title: res.result.message, icon: 'success' })
      getUserList() // åˆ·æ–°åˆ—è¡¨
    } else {
      uni.showToast({ title: res.result.message, icon: 'none' })
    }
  } catch (e) {
    uni.showToast({ title: 'åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥', icon: 'none' })
  }
}

// æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
const viewUserDetail = (userId) => {
  uni.navigateTo({ url: `/admin/pages/user/detail?userId=${userId}` })
}

// æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
const showDeleteConfirm = (userId) => {
  console.log('ç‚¹å‡»åˆ é™¤æŒ‰é’®, userId:', userId)
  if (!userId) {
    uni.showToast({ title: 'ç”¨æˆ·IDæ— æ•ˆ', icon: 'none' })
    return
  }
  deleteUserId.value = userId
  
  if (deletePopupRef.value !== null) {
    deletePopupRef.value.open()
  } else {
    console.error('å¼¹çª—ç»„ä»¶å¼•ç”¨æœªæ‰¾åˆ°')
    uni.showToast({ title: 'ç³»ç»Ÿé”™è¯¯', icon: 'none' })
  }
}

// ç¡®è®¤åˆ é™¤ç”¨æˆ·
const confirmDelete = async () => {
  try {
    const res = await uniCloud.callFunction({
      name: 'admin-api',
      data: {
        action: 'deleteUser',
        user_id: deleteUserId.value,
        token: uni.getStorageSync('adminToken')
      }
    })
    if (res.result.code === 200) {
      uni.showToast({ title: 'ç”¨æˆ·åˆ é™¤æˆåŠŸ', icon: 'success' })
      if (deletePopupRef.value !== null) {
        deletePopupRef.value.close()
      }
      // ç­‰å¾… Toast æ˜¾ç¤ºå®Œæ¯•å†åˆ·æ–°
      setTimeout(() => {
        getUserList() 
      }, 1500)
    } else {
      uni.showToast({ title: res.result.message || 'åˆ é™¤å¤±è´¥', icon: 'none' })
    }
  } catch (e) {
    console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', e)
    uni.showToast({ title: 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', icon: 'none' })
  }
}

// å–æ¶ˆåˆ é™¤
const cancelDelete = () => {
  if (deletePopupRef.value !== null) {
    deletePopupRef.value.close()
  }
}

// åˆ‡æ¢é¡µç 
const changePage = (newPage) => {
  if (newPage < 1 || newPage > totalPages.value) return
  page.value = newPage
  getUserList()
}

// æ—¥æœŸæ ¼å¼åŒ–
const formatDate = (timestamp) => {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
}
</script>

<style scoped>
.user-manage {
  /* å¢åŠ é¡µé¢ç•™ç™½ */
  padding: 0; 
}

.filter-card {
  background-color: #fff;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 16px;
  align-items: center;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
}

.filter-item {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.search-box {
  background-color: #f5f5f7;
  border-radius: 8px;
  padding: 0 12px;
  height: 40px;
  width: 300px;
  display: flex;
  flex-direction: row;
  align-items: center;
}

.search-icon {
  color: #999;
  margin-right: 8px;
}

.search-input {
  flex: 1;
  font-size: 14px;
  color: #333;
}

.date-range {
  background-color: #f5f5f7;
  border-radius: 8px;
  padding: 0 12px;
  height: 40px;
}

.date-picker {
  font-size: 14px;
  color: #666;
  padding: 0 8px;
  cursor: pointer;
}

.date-separator {
  color: #999;
  margin: 0 8px;
}

.select-box {
  background-color: #f5f5f7;
  border-radius: 8px;
  padding: 0 12px;
  height: 40px;
  min-width: 120px;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  color: #333;
  cursor: pointer;
}

.arrow {
  font-size: 12px;
  color: #999;
  margin-left: 8px;
}

.btn {
  height: 40px;
  padding: 0 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: opacity 0.2s;
}

.btn:hover { opacity: 0.9; }
.btn-primary { background-color: #007aff; color: #fff; }

.table-card {
  background-color: #fff;
  border-radius: 12px;
  padding: 30px; /* å¢åŠ ç•™ç™½ */
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
  /* å…è®¸å¡ç‰‡å†…æ¨ªå‘æ»šåŠ¨ï¼Œä½†å»ºè®®ç”¨ä¸“é—¨çš„scrollå®¹å™¨ */
  overflow: hidden; 
}

/* æ–°å¢ï¼šè¡¨æ ¼æ»šåŠ¨å®¹å™¨ */
.table-scroll {
  width: 100%;
  overflow-x: auto;
  padding-bottom: 10px; /* é¢„ç•™æ»šåŠ¨æ¡ç©ºé—´ */
}

.table-header {
  display: flex;
  flex-direction: row;
  padding: 16px 20px; /* å¢åŠ å†…è¾¹è· */
  background-color: #f9f9fa;
  border-radius: 8px;
  margin-bottom: 12px;
  font-weight: 600;
  color: #555; /* ä¼˜åŒ–å­—ä½“é¢œè‰² */
  font-size: 14px; /* ä¼˜åŒ–å­—ä½“å¤§å° */
  min-width: 900px; /* ç¡®ä¿æœ€å°å®½åº¦ï¼Œè§¦å‘æ»šåŠ¨ */
}

.table-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 20px; /* å¢åŠ è¡Œé«˜/å†…è¾¹è· */
  border-bottom: 1px solid #f5f5f5;
  transition: background 0.2s;
  min-width: 900px; /* ç¡®ä¿æœ€å°å®½åº¦ï¼Œè§¦å‘æ»šåŠ¨ */
}

.table-row:hover {
  background-color: #f5f5f7;
}

.col { 
  flex: 1; 
  padding: 0 10px; /* å¢åŠ åˆ—é—´è· */
  overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡ºå®¹å™¨ */
}
.col-user { flex: 2; min-width: 240px; }
.col-date { flex: 1.5; color: #666; font-size: 14px; min-width: 150px; }
.col-status { flex: 1; min-width: 100px; }
.col-action { 
  flex: 1.5; 
  text-align: right; 
  min-width: 200px; 
  white-space: nowrap; 
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  align-items: center;
  position: relative;
  z-index: 2; /* æå‡å±‚çº§ */
}

.user-cell {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.user-avatar {
  width: 44px; /* ç¨å¾®è°ƒå¤§å¤´åƒ */
  height: 44px;
  background-color: #007aff;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  margin-right: 16px;
}

.user-info {
  display: flex;
  flex-direction: column;
}

.username {
  font-size: 15px;
  font-weight: 500;
  color: #333;
  margin-bottom: 4px;
}

.email {
  font-size: 13px;
  color: #888;
}

.status-badge {
  padding: 6px 16px;
  border-radius: 16px;
  font-size: 13px;
  font-weight: 500;
}

.status-badge.active { background-color: #e6f7ff; color: #007aff; }
.status-badge.disabled { background-color: #fff0f0; color: #ff3b30; }

.action-btn {
  font-size: 13px;
  padding: 4px 12px;
  margin-left: 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f5; /* é»˜è®¤èƒŒæ™¯ï¼Œå¢åŠ ç‚¹å‡»åŒºåŸŸå¯è§†æ„Ÿ */
}

.action-btn:hover { opacity: 0.8; }
.action-btn.primary { color: #007aff; background-color: #e6f7ff; }
.action-btn.warning { color: #ff9500; background-color: #fff7e6; }
.action-btn.danger { color: #ff3b30; background-color: #fff0f0; }

.pagination-container {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid #f5f5f5;
}

.total-text {
  font-size: 14px;
  color: #999;
}

.page-ctrl {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 12px;
}

.page-btn {
  height: 32px;
  padding: 0 16px;
  border-radius: 6px;
  background-color: #fff;
  border: 1px solid #e5e5e5;
  font-size: 13px;
  color: #666;
  display: flex;
  flex-direction: row;
  align-items: center;
  cursor: pointer;
}

.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.page-num {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}
</style>
